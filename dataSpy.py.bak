# -*- coding: UTF-8 -*-
from bilibili_api import sync, search, settings
from collections import OrderedDict
import json
import random
import time

def wait():
    sec = 2.33 #è¿™é‡Œå¡«ç­‰å¾…ç§’ å¤ªå¿«ä¼šè¢« -412 æ‹¦æˆª
    time.sleep(sec)
    print("ç­‰ç­‰é™ˆç¿",sec,"ç§’")

def videoSearch(kw, pg):  # å“”å“©å“”å“©æœç´¢ kw=å…³é”®è¯ï¼ˆï¼‰ pg=é¡µé¢ï¼ˆintï¼‰
    #print("æœç´¢è§†é¢‘ï¼Œå…³é”®è¯â€œ", kw, "â€ï¼Œç¬¬", pg, "é¡µã€‚")
    result = sync(search.web_search(keyword=kw, page=pg))
    wait()
    return result


def dataSpy(kw, pg):  # æ•°æ®æ‰è™«
    info = videoSearch(kw, pg)  # è·å–æœç´¢åŸå§‹ä¿¡æ¯

    # è¿‡æ»¤è§†é¢‘æœç´¢ç»“æœ
    result = info['result']
    for a in result:
        if a["result_type"] == "video":
            #print("Is a video dict!",a)
            videoResult = a["data"]
        else:
            #print("ğŸ˜­", a)
            pass

    authorBlackList = ["EOEç»„åˆ", "éœ²æ—©GOGO", "ç±³è¯ºé«˜åˆ†å°‘å¥³", "èå„¿ç¡ä¸é†’", "æŸšæ©ä¸åŠ ç³–", "è™è«MOMO"]
    __weight_determination = 0
    times = 0
    for i in videoResult:  # å¤„ç†æœç´¢ç»“æœ è®¡ç®—æƒé‡
        times = times+1
        # print("ğŸ˜¤",i)
        __weight_determination = 0
        __weight = 0
        for b in i:
            if b == "title":  # æ¶ˆé™¤ <em> å…³é”®è¯æ ‡è®°
                #print(i[b].replace('<em class="keyword">', "").replace('</em>', ""))
                i[b] = i[b].replace('<em class="keyword">',
                                    "").replace('</em>', "")
                print("æ ‡é¢˜ï¼š", i[b])
                # if i[b].find("å¤šç±³è¯º") != -1:
                #     videoResult.remove(i)
                #     __weight_determination = -1
                #     break
            if b == "author":  # æƒé‡ å®˜æ–¹è§†é¢‘ æƒé‡-20
                if i in authorBlackList:
                    __weight_determination = int(__weight_determination - 2000)
                    #print("æ£€æµ‹åˆ°ä½œè€…")
                else:
                    __weight_determination = __weight_determination
                #print("è®¡ç®—ä½œè€…æƒé‡ï¼š", __weight_determination)
            if b == "like":  # æƒé‡ è®¡ç®—ç‚¹èµ
                __like = i[b]
                if i[b] <= 900:  # æƒé‡ è‹¥ç‚¹èµå°äº50 æƒé‡+100+ç‚¹èµé‡
                    __weight_determination = __weight_determination + 100 + i[b]
                else:  # æƒé‡ å¦‚æœéƒ½ä¸åŒ¹é… æƒé‡+35+ç‚¹èµé‡
                    __weight_determination = __weight_determination + \
                        35 + int(i[b]*0.2)
                #print("è®¡ç®—ç‚¹èµæƒé‡ï¼š", __weight_determination)
            if b == "coin":  # æƒé‡ è®¡ç®—æŠ•å¸
                if __like <= i[b]:  # æƒé‡ è‹¥æŠ•å¸æ¯”ç‚¹èµå¤š æƒé‡+40+æŠ•å¸é‡
                    __weight_determination = __weight_determination + 70 + i[b]
                elif i[b] >= 86:  # æƒé‡ è‹¥æŠ•å¸å¤§äº86 æƒé‡-10+æŠ•å¸é‡
                    __weight_determination = __weight_determination - 5 + i[b]
                else:  # æƒé‡ å¦‚æœéƒ½ä¸åŒ¹é… æƒé‡+20+æŠ•å¸é‡
                    __weight_determination = __weight_determination + 20 + i[b]
                #print("è®¡ç®—æŠ•å¸æƒé‡ï¼š", __weight_determination)
            if b == "favorites":  # æƒé‡ æ”¶è— æƒé‡æ”¶è—*2
                __weight_determination = int(
                    __weight_determination + (i[b]*0.5))
                #print("è®¡ç®—æ”¶è—æƒé‡ï¼š", __weight_determination)

            if b == "senddate":  # æƒé‡ 5*24*60*60ç§’åï¼ˆäº”å¤©åï¼‰æƒé‡*0.1
                __sendTimeCalc = int(int(time.time()) - int(i[b]))
                if __sendTimeCalc >= 432000:
                    __weight_determination = int(
                        __weight_determination*0.1-999)
                if __sendTimeCalc <= 259200:
                    __weight_determination = int(
                        __weight_determination*1.3)
                #print("è®¡ç®—æ—¶é—´æƒé‡ï¼š", __weight_determination)
            if b == "play":
                if i[b] <= 7000:
                    __weight_determination = int(
                        __weight_determination+int(i[b]*0.1)+10)
                if i[b] <= 5000:
                    __weight_determination = int(
                        __weight_determination+int(i[b]*0.2)+10)
                if i[b] <= 2000:
                    __weight_determination = int(
                        __weight_determination+int(i[b]*0.3))
                #print("è®¡ç®—ç‚¹é˜…æƒé‡ï¼š", __weight_determination)
            if b == "video_review":
                if i[b] <= 100:
                    __weight_determination = int(
                        __weight_determination + (i[b]*1.2))
                #print("è®¡ç®—å¼¹å¹•æƒé‡ï¼š", __weight_determination)

        __weight = 40 + random.randint(-10, 50) + __weight_determination
        print("æœ€ç»ˆæƒé‡ï¼š", __weight)
        i.update({"__weight": __weight})

        i = videoResult

    #print(videoResult)
    return videoResult

    # print(result)


#dataSpy("ç±³è¯º", 3)
def makeMutiPageResultJson(keyword):
    result = []
    page = videoSearch(keyword, 1)["numPages"]
    if page >= 20:
        page = 20
    for i in range(1, page):
        #print("ç¬¬{}é¡µ".format(i))
        result = result + dataSpy(keyword, i)
        wait()
    #print(result)
    return result


def makeJsonFile():
    result = []
    nameList = ["EOE", "éœ²æ—©", "ç±³è¯º", "èå„¿", "æŸšæ©", "è™è«"]
    for i in nameList:
        result = result + makeMutiPageResultJson(i)
    Order = OrderedDict()
    for item in result:
        Order.setdefault(item['bvid'], {**item, })
    Order = list(Order.values())
    result = Order
    result.sort(key=lambda x: x["__weight"])
    result.reverse()
    # del result[-20: -1]
    # del result[0: 5]
    BlockWord = ["å¤šç±³è¯º", "å‡‡å­M", "é»‘çŒ«ä¸ç™½å–µ", "ç±³è¯ºåœ°å°”", "æ˜æ—¥æ–¹èˆŸæ—©éœ²", "æ˜æ—¥æ–¹èˆŸ", "èˆ’èˆ’é…·åŒ—åŒ—", "è´¤å®å®Baby", "å¤šç±³è¯ºéª¨ç‰Œ"]  # æ— å…³ç»“æœ
    #print("åˆ—è¡¨é•¿åº¦ï¼š",len(result))
    the_times = 0
    for __useless_variable in range(0,30):
        the_times = the_times + 1
        #print("ç¬¬{}æ¬¡è¿è¡Œ".format(the_times))
        for bL in BlockWord:
            for i in result:
                if i['title'].find(bL) != -1:
                    #print("å·²åˆ é™¤é»‘åå•ã€‚",bL)
                    try:
                        result.remove(i)
                    except ValueError:
                        pass
                if i['author'].find(bL) != -1:
                    #print("å·²åˆ é™¤é»‘åå•ã€‚",bL)
                    try:
                        result.remove(i)
                    except ValueError:
                        pass
                if i['description'].find(bL) != -1:
                    #print("å·²åˆ é™¤é»‘åå•ã€‚", bL)
                    try:
                        result.remove(i)
                    except ValueError:
                        pass
                if i['description'].find(bL) != -1:
                    #print("å·²åˆ é™¤é»‘åå•ã€‚", bL)
                    try:
                        result.remove(i)
                    except ValueError:
                        pass
                if i['tag'].find(bL) != -1:
                    #print("å·²åˆ é™¤é»‘åå•ã€‚", bL)
                    try:
                        result.remove(i)
                    except ValueError:
                        pass
    print("\n\nè¿è¡Œå®Œæ¯•ï¼Œåˆ—è¡¨é•¿åº¦ï¼š", len(result))
    return result


result = makeJsonFile()

resultJson = open("result.json", "w", encoding="utf-8")
resultJson.write(str(result))
resultJson.close()
